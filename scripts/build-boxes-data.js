const fs = require('fs');
const path = require('path');

const root = path.join(__dirname, '..');
const configPath = path.join(root, 'content', 'boxes-config.json');
const wordsPath = path.join(root, 'content', 'boxes-words.json');
const tokenizedPath = path.join(root, 'content', 'boxes-tokenized.json');
const outPath = path.join(root, 'boxes-data.js');

const config = JSON.parse(fs.readFileSync(configPath, 'utf8'));
const words = JSON.parse(fs.readFileSync(wordsPath, 'utf8'));

let tokenizedSentences = {};
let tokenizedVersion = null;
try {
  const raw = fs.readFileSync(tokenizedPath, 'utf8');
  const arr = JSON.parse(raw);
  if (Array.isArray(arr)) {
    for (let i = 0; i < arr.length; i++) {
      const s = arr[i];
      if (s && s.ja) tokenizedSentences[s.ja] = s;
    }
    if (arr[0] && arr[0].version) tokenizedVersion = arr[0].version;
    else if (Object.keys(tokenizedSentences).length > 0) tokenizedVersion = '1.0';
  }
} catch (e) {
  // boxes-tokenized.json optional
}

const versionStr = tokenizedVersion != null ? JSON.stringify(tokenizedVersion) : 'null';
const js =
  '// Generated by scripts/build-boxes-data.js â€” do not edit by hand\n' +
  'const BOXES_CONFIG = ' + JSON.stringify(config) + ';\n' +
  'const BOXES_WORDS = ' + JSON.stringify(words) + ';\n' +
  'const BOXES_TOKENIZED_SENTENCES = ' + JSON.stringify(tokenizedSentences) + ';\n' +
  'const BOXES_TOKENIZED_VERSION = ' + versionStr + ';\n';

fs.writeFileSync(outPath, js, 'utf8');
console.log('Wrote boxes-data.js (same folder as boxes.html). Boxes can run without a server.');
