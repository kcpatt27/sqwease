/**
 * Build content/common-kanji.json from kanjiapi.dev (grade 1 + grade 2 = 240 kanji).
 * Run: node scripts/build-common-kanji.js
 * Requires Node 18+ (fetch). Reads/writes UTF-8.
 */

const fs = require('fs');
const path = require('path');

const ROOT = path.join(__dirname, '..');
const OUT_PATH = path.join(ROOT, 'content', 'common-kanji.json');
const API_BASE = 'https://kanjiapi.dev/v1/kanji/';
const MAX_KANJI = 250;

async function fetchJson(url) {
  const res = await fetch(url);
  if (!res.ok) throw new Error(url + ' ' + res.status);
  return res.json();
}

async function main() {
  const grade1 = await fetchJson(API_BASE + 'grade-1');
  const grade2 = await fetchJson(API_BASE + 'grade-2');
  const chars = [...(Array.isArray(grade1) ? grade1 : []), ...(Array.isArray(grade2) ? grade2 : [])].slice(0, MAX_KANJI);

  const list = [];
  for (let i = 0; i < chars.length; i++) {
    const c = chars[i];
    try {
      const data = await fetchJson(API_BASE + encodeURIComponent(c));
      const kun = (data.kun_readings || []).filter(Boolean);
      const on = (data.on_readings || []).filter(Boolean);
      const readings = [...kun, ...on].join(', ');
      const meaning = (data.meanings || []).join(', ');
      list.push({ character: c, readings, meaning });
    } catch (e) {
      console.warn('Skip ' + c + ': ' + e.message);
    }
    if ((i + 1) % 50 === 0) console.log('Fetched ' + (i + 1) + '/' + chars.length);
  }

  fs.writeFileSync(OUT_PATH, JSON.stringify(list, null, 2), 'utf8');
  const jsPath = path.join(ROOT, 'content', 'common-kanji.js');
  fs.writeFileSync(
    jsPath,
    '// Generated by scripts/build-common-kanji.js\nwindow.COMMON_KANJI = ' + JSON.stringify(list) + ';\n',
    'utf8'
  );
  console.log('Wrote ' + list.length + ' kanji to content/common-kanji.json and content/common-kanji.js');
}

main().catch((e) => {
  console.error(e);
  process.exit(1);
});
